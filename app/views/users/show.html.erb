<%= link_to "Welcome", root_path %> /
<%= link_to "Users", users_path %> /
<%= @user.name %>

<h1>User Dashboard for <%= @user.name %></h1>
<hr>

<p>
    We just created an MX user with the API. The next step is to connect them to an institution so the user can view their accounts.
</p>

<section>
    <h2>Step 2 Connect an Institution</h2>

    <p>
        MX provides developers with the Connect Widget to simplify the process of connecting to various institutions.  In order to show the widget there are a few steps to follow.
    </p>

    <ol>
        <li>Get a widget url from the API</li>
        <li>Use the widget url in the Widget Loader to render it on the page</li>
    </ol>

    <%= render "/http_example", description: "To generate a widget URL, you send an http message to:", method: "POST", url: "/users/{user_guid}/widget_urls" %>

    <p>(optional) If you want to see what a URL looks like, click the button to call the endpoint above.</p>
    <button id="gen-url">Generate a URL</button>

    <p>Clicking the button below will both generate the url, and use it with the Widget Loader.  Go ahead and open the Connect Widget by clicking the button</p>

    <button id="open-aggregation">Open Connect Widget</button>
</section>

<section>
    <h2>Step 3 Verify Member Accounts</h2>

    <p>In order to share account information with an external partner an account must be verified first.  This action can also be done using the Connect Widget using "verification" mode</p>

    <p>Clicking the button below will generate a widget url, and render it using the Widget Loader.  The difference from this instance and before, is our request for the url specifies that we want to use "verification" mode</p>

    <button id="open-verification">Open Connect Widget (Verification)</button>
</section>

<section>
    <h2>Step 4 Display Accounts</h2>

    <button id="load-accounts">Load User Accounts</button>

    <div id="user-accounts"></div>
</section>

<div id="connect-widget-dialog" class="connect-widget-full" hidden>
    <div id="aggregation-instructions">
        <h2>Connect Widget (Aggregation Mode)</h2>
        <div>Click "Continue"</div>
        <div>Search for "MX Bank"</div>
        <div>user: mxuser</div>
        <div>password: password</div>
        <br>
    </div>
    <div id="verification-instructions">
        <h2>Connect Widget (Verification Mode)</h2>
        <div>Click "Continue"</div>
        <div>Select "MX Bank"</div>
        <div>Once verification is done, close the widget</div>
        <br>
    </div>
    <button id="widget-close">Close Widget</button>
    <div id="connect-widget"></div>
</div>

<script>
    /** 
      * @param callbackForUrl: (url) => {}
      */
    function getWidgetURL(callbackForUrl) {
        fetch("/mx/aggregation/<%= @user.guid %>")
        .then(resp => resp.text())
        .then(widgetResponse => {
            let widgetURL = null
            try {
                widgetURL = JSON.parse(widgetResponse).url
            } catch (error) {
                console.error("Error getting widget URL to load")
                return
            }

            callbackForUrl(widgetURL)
        })
    }

    function showDialog(type) {
        document.getElementById("connect-widget-dialog").hidden = false

        // Show and Hide instructions
        document.getElementById('verification-instructions').hidden = true
        document.getElementById('aggregation-instructions').hidden = true

        if (type == "aggregation") {
            document.getElementById('aggregation-instructions').hidden = false
        }

        if (type == "verification") {
            document.getElementById('verification-instructions').hidden = false
        }
    }

    function dismissDialog() {
        document.getElementById("connect-widget-dialog").hidden = true
        var connectIFrame = document.querySelector('iframe[title="Connect"]')
        connectIFrame.remove()
    }

    document.getElementById('gen-url').addEventListener('click', () =>
        getWidgetURL((url) => alert(url))
    )

     document.getElementById('widget-close').addEventListener('click', () => {
         dismissDialog()
     })

    // This sets up the MX Widget Loader
    var mxConnect = new window.MXConnect({
        id: "connect-widget",
        iframeTitle: "Connect",
        /**
        * Callback that for handling all events within Connect.
        * Only called in  ui_message_version 4 or higher.
        *
        * The events called here are the same events that come through post
        * messages.
        */
        onEvent: function (type, payload) {
            console.log("onEvent", type, payload);

            if (type === "mx/connect/connected/primaryAction") {
                // custom code for your app to close the widget
                dismissDialog()
            }
        },
        config: {
            ui_message_version: 4
        },
        targetOrigin: "*",
    })

    document.getElementById('open-aggregation').addEventListener('click', () => {
        // This endpoint will get a fresh widget url for aggregation
        fetch("/mx/aggregation/<%= @user.guid %>")
        .then(resp => resp.text())
        .then(widgetResponse => {
            let widgetURL = null
            try {
                widgetURL = JSON.parse(widgetResponse).url
            } catch (error) {
                console.error("Error getting widget URL to load")
                return
            }

            mxConnect.load(widgetURL)

            // Custom code to unhide the div containing the widget
            showDialog("aggregation")
        })
    })

    document.getElementById('open-verification').addEventListener('click', () => {
        // This endpoint will get a fresh widget url for verification
        fetch("/mx/verification/<%= @user.guid %>")
        .then(resp => resp.text())
        .then(widgetResponse => {
            let widgetURL = null
            try {
                widgetURL = JSON.parse(widgetResponse).url
            } catch (error) {
                console.error("Error getting widget URL to load")
                return
            }

            mxConnect.load(widgetURL)
            showDialog("verification")
        })
    })

    // Accounts loading via fetch
    // Load the HTML, and then set up the buttons
    function setUpAccountButtons() {
        document.querySelectorAll("button[data-account-guid]").forEach(element => {
            element.addEventListener("click", () => {
                const accountGUID = element.getAttribute("data-account-guid")
                const memberGUID = element.getAttribute("data-member-guid")
                const userGUID = element.getAttribute("data-user-guid")

                // Ask Rails to fetch an auth code for the account
                fetch(`/mx/accounts/generate-auth-code/${accountGUID}/${memberGUID}/${userGUID}`)
                .then(resp => resp.text())
                .then(resp => {
                    try {
                        parsedResponse = JSON.parse(resp)
                        document.querySelector(`td[data-account-guid='${accountGUID}'`).innerText = parsedResponse.authorization_code
                    } catch (error) {
                        console.error(error)
                    return
                    }
                })
            })
        })
    }

    document.getElementById('load-accounts').addEventListener('click', () => {
        fetch("/mx/accounts/<%= @user.guid %>")
        .then(resp => resp.text())
        .then(accountsHTML => {
            document.getElementById("user-accounts").innerHTML = accountsHTML
            setUpAccountButtons()
        })
    })
</script>